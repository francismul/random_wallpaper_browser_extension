name: Build and Release Extension

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v2.1.1, etc.
  workflow_dispatch:  # Allows manual triggering from GitHub Actions tab

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required for creating releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build extension (heavy obfuscation)
        run: pnpm build:heavy
      
      - name: Get version from package.json
        id: package_version
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
      
      - name: Create zip archive
        run: |
          cd dist
          zip -r ../random-wallpaper-extension-v${{ steps.package_version.outputs.VERSION }}.zip .
          cd ..
      
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Random Wallpaper Extension v${{ steps.package_version.outputs.VERSION }}
          body: |
            ## Random Wallpaper Browser Extension v${{ steps.package_version.outputs.VERSION }}
            
            ### Installation Instructions
            
            1. Download the `random-wallpaper-extension-v${{ steps.package_version.outputs.VERSION }}.zip` file below
            2. Extract the zip file to a folder on your computer
            3. Open your browser's extension management page:
               - **Chrome**: Navigate to `chrome://extensions/`
               - **Edge**: Navigate to `edge://extensions/`
               - **Brave**: Navigate to `brave://extensions/`
            4. Enable "Developer mode" (toggle in the top right corner)
            5. Click "Load unpacked" button
            6. Select the extracted folder containing the extension files
            7. The extension should now be installed and active!
            
            ### Features
            - Random wallpapers from Unsplash and Pexels APIs
            - Offline support with fallback images
            - Customizable refresh intervals
            - View history tracking
            - Permanent cache mode option
            
            ### What's Changed
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for detailed changes.
          draft: false
          prerelease: false
      
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./random-wallpaper-extension-v${{ steps.package_version.outputs.VERSION }}.zip
          asset_name: random-wallpaper-extension-v${{ steps.package_version.outputs.VERSION }}.zip
          asset_content_type: application/zip
